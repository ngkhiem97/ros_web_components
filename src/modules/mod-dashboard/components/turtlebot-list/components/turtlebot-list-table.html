<link rel="import" href="../../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../../bower_components/ros-websocket/ros-websocket.html">
<link rel="import" href="../../../../../../bower_components/ros-topic/ros-topic.html">

<!-- Script for data table -->
<script src="./../../../../../libraries/ajax/libs/jquery/3.3.1/jquery.js" charset="utf-8"></script>
<script src="./../../../../../libraries/datatables/1.10.16/js/jquery.dataTables.js" charset="utf-8"></script>
<script src="./../../../../../libraries/ajax/libs/datatables/1.10.16/js/dataTables.bootstrap4.js" charset="utf-8"></script>

<dom-module id="turtlebot-list-table">
    <template>
        <!-- Bootstrap styling -->
        <link href="./../../../../../src/libraries/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
        <link href="./../../../../../src/libraries/ajax/libs/datatables/1.10.16/css/dataTables.bootstrap4.css" rel="stylesheet">
        
        <style>
            :host {
                display: block;
                font-family: 'Open Sans', sans-serif;
            }
            paper-button.turtlebot-detail {
                color: white;
                background: #3B3A4D;
            }
            paper-button.turtlebot-connect {
                color: white;
                background: #3B3A4D;
            }
        </style>
        
        <!-- Connect to ROS Web Socket node -->
        <ros-websocket auto id="ros" ros="{{ros}}" url="{{url}}" on-connection="_handleConnection"
        on-close="_handleClose" on-error="_handleError"></ros-websocket>
        
        <!-- Register to cmd_vel topic published by turtlebot3_teleop node -->
        <ros-topic id="robotListTopic" 
            ros="{{ros}}" 
            topic="/turtlebot_service/robot_manager/list" 
            msg-type="turtlebot_service/RobotList"
            auto="true"
            on-message="_handleMessage">
        </ros-topic>
        
        <!-- Turtlebot list table -->
        <div class="card">
            <div class="card-header">
                <i class="fa fa-table"></i> Turtlebot list
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Robot ID</th>
                                <th>Status</th>
                                <th>Connected at</th>
                                <th>Detail</th>
                                <th>SLAM</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template id="turtlebotListTemplate" is="dom-repeat" items="{{robots}}">
                                <tr>
                                    <td>[[item.robot_id]]</td>
                                    <td>Available</td>
                                    <td>[[item.created_at]]</td>
                                    <td>
                                        <paper-button index="[[index]]" class="turtlebot-detail" on-click="_showDetail">Show detail
                                        </paper-button>
                                    </td>
                                    <td>
                                        <paper-button id="[[item.robot_id]]" class="turtlebot-connect" on-click="_connect">connect
                                        </paper-button>
                                    </td>
                                </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer small text-muted">Updated yesterday at 11:59 PM</div>
        </div>
    </template>
    
    <script>
        /**
        * @customElement
        * @polymer
        */
        class TurtlebotListTable extends Polymer.Element {
            static get is() { return 'turtlebot-list-table'; }
            static get properties() {
                return {
                    detailInfo: {
                        type: Object,
                        value: {}
                    },
                    robots: {
                        type: Object,
                        value: []
                    },
                }
            }
            ready() {
                super.ready();
            }
            _connect(e) {
                window.location.href = "/turtlebot/slam/" + e.target.id;
            }
            _handleMessage(msg) {
                this.robots = msg.detail.robots;
                this.$.turtlebotListTemplate.render();
                // initialize datatable
                $(this.$.dataTable).DataTable({
                    "lengthMenu": [[5, 10, -1], [5, 10, "All"]]
                });
                this.$.robotListTopic.unsubscribe();
            }
            _showDetail(e) {
                this.detailInfo = this.robots[e.target.index];
                this.dispatchEvent(new CustomEvent('show-detail', {detail: this.detailInfo}));
            }
        }
        window.customElements.define(TurtlebotListTable.is, TurtlebotListTable);
    </script>
</dom-module>