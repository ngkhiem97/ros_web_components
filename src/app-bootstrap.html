<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="modules/mod-auth/services/service-account.html">

<dom-module id="app-bootstrap">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        
        <!-- Binds to the app's URL -->
        <app-location route="{{route}}"></app-location>
        
        <!-- Manages the top-level routes data -->
        <app-route route="{{route}}"
            pattern="/:page"
            data="{{routeData}}"
            tail="{{subroute}}">
        </app-route>
    
        <!-- Ajax component for login service -->
        <service-account id="serviceAccount" on-response="_authorizeSuccess"
            on-error="_authorizeError"></service-account>
        
        <!-- URL Routing elements -->
        <div id="appPage" hidden="true">
            <iron-pages id="appPage" role="main" selected="[[page]]" attr-for-selected="name" selected-attribute="visible" fallback-selection="404">
                
                <!-- Authentication module -->
                <mod-auth name="auth" route="[[subroute]]"></mod-auth>
                
                <!-- Dashboard module -->
                <mod-dashboard name="dashboard" route="[[subroute]]"></mod-dashboard>
                
                <!-- Turtlebot module -->
                <mod-turtlebot name="turtlebot" route="[[subroute]]"></mod-turtlebot>
                
                <!-- Not found -->
                <div name="404">
                    <h3>app-bootstrap::Page could not be found!{{page}}</h3>
                </div>
            </iron-pages>
        </div>
        
    </template>

<script>
    /**
    * @customElement
    * @polymer
    */
    class AppBootstrap extends Polymer.Element {
        static get is() { return 'app-bootstrap'; }
        static get properties() {
            return {
                page:{
                    type: String,
                    reflectToAttribute: true,
                    observer: '_pageChanged'
                }
            };
        }
        static get observers() {
            return ['_routerChanged(routeData.page)'];
        }
        
        _routerChanged(page) {
            this._authorized();
        }
        _authorized() {
            this.$.serviceAccount.check();
        }
        _authorizeSuccess(res) {
            if (this.routeData.page == 'auth') {
                this.page = 'dashboard';
            } else {
                this.page = this.routeData.page || 'dashboard';
            }
            this.$.appPage.hidden = false;
        }
        _authorizeError(res) {
            this.subroute = {}; // resest the subroute.          ex: /dashboard/list -> /dashboard
            this.page = 'auth'; // return to authorization page. ex: /dashboard -> /auth
            this.$.appPage.hidden = false;
        }

        // After successfully resolved page
        _pageChanged(page) {
            
            // Load page import on demand. Show 404 page if fails
            var resolvedPageUrl = this.resolveUrl('modules/mod-'+page+'/mod-'+page+'.html');
            Polymer.importHref(
                resolvedPageUrl,
                null,
                this._showPage404.bind(this),
                true
            );
        }
        _showPage404() {
            this.page = '404';
        }
    }
    
    window.customElements.define(AppBootstrap.is, AppBootstrap);
</script>
</dom-module>
